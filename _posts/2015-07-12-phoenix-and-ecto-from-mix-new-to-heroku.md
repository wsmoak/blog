---
layout: post
title:  "Phoenix and Ecto: From `mix new` to Heroku"
date:   2015-07-12 14:49:00
tags: elixir phoenix ecto heroku
---

In [Deploying a Phoenix app to Heroku](...) we looked at the absolute minimum necessary to get the Hello Phoenix app running on Heroku.  This involved modifying config files and adding some environment variables.

Now let's start over and deploy a more realistic app, one that actually uses a database, so we can make sure it really works.

### Step 1: Create a sample app and get it under version control

The first steps are the same, create a new Phoenix app and get it under version control:

<pre>
$ mix phoenix.new my_app
$ cd my_app
$ git init && git add . && git commit -m "Initial commit of Phoenix app"
</pre>

Now if anything goes wrong, we can back up to this point.

### Step 2: Choose a License

The next thing to do is to choose a license for your project.  If your project has a chance of ever getting out in public, for example if you are going to put it on GitHub, it's important to include a license so that someone coming upon it later understands what your intentions are and what they are allowed to do with your code.

I've been involved with The Apache Software Foundation for years and years, and I prefer the Apache License.  Many projects (and Phoenix itself) use the MIT License.  GitHub has an excellent article on how to choose a license and why you should do so.

Enough of my soapbox. If you're going to, add your LICENSE file and commit it.

<pre>
$ curl http://www.apache.org/licenses/LICENSE-2.0.txt > LICENSE
$ git add LICENSE && git commit -m "Add Apache License 2.0"
</pre>

(If you'd like to automate adding the MIT license to your project, this looks like an interesting option: <https://github.com/remy/mit-license> .)

### Step 3: Add a Users model

Let's add a simple model for a User by following part of the [Ecto Models](http://www.phoenixframework.org/docs/ecto-models) guide.

<pre>
$ mix phoenix.gen.html User users name:string email:string
$ git add . && git commit -m "Add generated User model"
</pre>

The output tells us to
<pre>
Add the resource to your browser scope in web/router.ex:

    resources "/users", UserController
</pre>

Open `web/router.ex` and paste that line in:

<pre>
  scope "/", MyApp do
    pipe_through :browser # Use the default browser stack

    get "/", PageController, :index
    resources "/users", UserController  # <------
  end
</pre>

(Remember to commit your changes.  I'll stop reminding you after this.)

### Step 4: Test locally

Now create the development database and run the migration.  (The [Ecto Models] guide has all the details on this.)

<pre>
$ mix ecto.create
$ mix ecto.migrate
</pre>

If you received errors here, check that Postgres is running locally.

At this point you can start the app locally with `mix phoenix.server`, visit the <http://localhost:4000/users> page, and check that adding, editing and deleting users works.

### Step 4: Modify prod configuration

The sample app generated by `mix phoenix.new` expects to import a `prod.secret.exs` file that we will not be using.  Remove this section from `config/prod.exs`:

<pre>
-
-# Finally import the config/prod.secret.exs
-# which should be versioned separately.
-import_config "prod.secret.exs"
</pre>

Instead, add the following to `prod.exs` (copied and modified from `config/prod.secret.exs`):

<pre>
# Configure secret_key_base for cookie-based session storage
  config :my_app_414711, MyApp_414711.Endpoint,
  secret_key_base: System.get_env("SECRET_KEY_BASE")

# Configure your database
  config :my_app_414711, MyApp_414711.Repo,
  adapter: Ecto.Adapters.Postgres,
  url: System.get_env("DATABASE_URL"),
  size: 20 # The amount of database connections in the pool
</pre>

### Step 3: Create the Heroku application

<pre>
$ heroku create
</pre>

A newly created Heroku application does not know anything about the language and frameworks used by the app. [Buildpacks][buildpacks] are used for this configuration. Add the Elixir buildpack first, followed by the Phoenix Static buildpack.

<pre>
$ heroku buildpacks:add https://github.com/HashNuke/heroku-buildpack-elixir
$ heroku buildpacks:add https://github.com/gjaldon/phoenix-static-buildpack
</pre>

Now add the PostgreSQL database to the Heroku project:

<pre>
$ heroku addons:create heroku-postgresql
</pre>

This will make the database available, but it will be empty.  We'll create the database tables and columns shortly.

Set the SECRET_KEY_BASE environment variable, which is used for cookie-based session storage.  See the Sessions doc for more information.

<pre>
$ heroku config:set SECRET_KEY_BASE=[long random string copied from config/prod.secret.exs]
</pre>

At this point we need to push our changes to Heroku so that it will build the app and get the environment set up.

<pre>
$ git push heroku master
</pre>

Now that Erlang and Elixir are installed, you can create the database and run the migration:

<pre>
$ heroku run mix ecto.create # ignore error, see below
$ heroku run mix ecto.migrate
</pre>

When running `heroku run mix ecto.create` I received this error:
<pre>
Running `mix ecto.create` attached to terminal... up, run.4650
** (Mix) The database for MyApp_1018711.Repo couldn't be created,
reason given: Error: You must install at least one postgresql-client-[version] package.
</pre>

According to <http://stackoverflow.com/questions/17300341/migrate-not-working-on-heroku> and in my experience, this can safely be ignored

And finally:
<pre>
$ heroku open
</pre>

Should open the index page of your app.  Add /users to the url and see it work!

### References

* [WIP Heroku deployment guide](https://github.com/phoenixframework/phoenix_guides/pull/314)
