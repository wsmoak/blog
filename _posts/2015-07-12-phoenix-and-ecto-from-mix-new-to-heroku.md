---
layout: post
title:  "Phoenix and Ecto: From `mix new` to Heroku"
date:   2015-07-12 14:49:00
tags: elixir phoenix ecto heroku
---

In [Deploying a Phoenix app to Heroku](...) we looked at the absolute minimum necessary to get the Hello Phoenix app running on Heroku.  This involved modifying config files and adding some environment variables.

Now let's start over and deploy a more realistic app, one that actually uses a database, so we can make sure it really works.

### Step 0: Prerequisites

Before you can begin, you need several things installed.  These include but may not be limited to: Erlang, Elixir, Postgres, NodeJS, Heroku Toolbelt, Phoenix, and Git.

Here are some links to get you started:

* <http://elixir-lang.org/install.html>
* <http://www.phoenixframework.org/docs/installation>
* <https://toolbelt.heroku.com>

If you have *any* problems at all, ask in #elixir-lang on Freenode IRC, in the Phoenix channel in Slack, phoenix-talk Google Group. If you don't know how to find or use those, ask below in the comments or send me an email, and I'll help you find the right place.

Now, let's begin.

### Step 0.5: Install the latest hex

One thing first! There was a bug in hex (the package manager) that was fixed Sunday morning 7/12, however depending on what you have downloaded recently, you may have the bad version.  Execute this command to [install hex locally](http://elixir-lang.org/docs/v1.0/mix/):

<pre>
$ mix local.hex
</pre>

Now we can get started.

### Step 1: Create a sample app and put it under version control

The first steps are the same, create a new Phoenix app and get it under version control:

<pre>
$ mix phoenix.new my_app
$ cd my_app
$ git init && git add . && git commit -m "Initial commit of Phoenix app"
</pre>

Now if anything goes wrong, we can back up to this point.

### Step 2: Choose a License

The next thing to do is to choose a license for your project.  If your project has a chance of ever getting out in public, for example if you are going to put it on GitHub, it's important to include a license so that someone coming upon it later understands what your intentions are and what they are allowed to do with your code.

I've been involved with The Apache Software Foundation for years and years, and I prefer the Apache License.  Many projects (and Phoenix itself) use the MIT License.  GitHub has an excellent [Choose A License](http://choosealicense.com) tool to help you decide.

Enough of my soapbox. If you're going to, add your LICENSE file and commit it.

<pre>
$ curl http://www.apache.org/licenses/LICENSE-2.0.txt > LICENSE
$ git add LICENSE && git commit -m "Add Apache License 2.0"
</pre>

(If you'd like to automate adding the MIT license to your project, this looks like an interesting option: <https://github.com/remy/mit-license> .)

### Step 3: Add a Users model

Let's add a simple model for a User by following part of the [Ecto Models][ecto-models] guide.

<pre>
$ mix phoenix.gen.html User users name:string email:string
$ git add . && git commit -m "Add generated User model"
</pre>

The output tells us to
<pre>
Add the resource to your browser scope in web/router.ex:

    resources "/users", UserController
</pre>

Open `web/router.ex` and paste that line in:

<pre>
  scope "/", MyApp do
    pipe_through :browser # Use the default browser stack

    get "/", PageController, :index
    resources "/users", UserController  # <------
  end
</pre>

(Remember to `git commit` your changes.)

NOTE:  If you run into an `Unchecked dependencies` error at this point, see the [Troubleshooting](#troubleshooting) section below.

### Step 4: Test locally

Now create the development database and run the migration.  (The [Ecto Models][ecto-models] guide has all the details on this.)

<pre>
$ mix ecto.create
$ mix ecto.migrate
</pre>

If you received errors here, check that Postgres is running locally.

At this point you can start the app with `mix phoenix.server`, visit the <http://localhost:4000/users> page, and check that adding, editing and deleting users works in the development environment.

### Step 5: Modify prod configuration

The sample app generated by `mix phoenix.new` expects to import a `prod.secret.exs` file that we will not be using.  Remove this section from `config/prod.exs`:

<pre>
-
-# Finally import the config/prod.secret.exs
-# which should be versioned separately.
-import_config "prod.secret.exs"
</pre>

Instead, add the following to `prod.exs` (copied and modified from `config/prod.secret.exs`):

<pre>
# Configure secret_key_base for cookie-based session storage
  config :my_app, MyApp.Endpoint,
  secret_key_base: System.get_env("SECRET_KEY_BASE")

# Configure your database
  config :my_app, MyApp.Repo,
  adapter: Ecto.Adapters.Postgres,
  url: System.get_env("DATABASE_URL"),
  size: 20 # The amount of database connections in the pool
</pre>

This tells Phoenix to get the DATABASE_URL and SECRET_KEY_BASE values from the environment, so that we don't have to include passwords and keys in plain text in our source code.  We'll set those values a bit later.

(Remember to `git commit` your changes.)

### Step 6: Create the Heroku application

<pre>
$ heroku create
</pre>

Self explanatory. :)  If this does not work, check that you have the Heroku Toolbelt installed.

### Step 7: Add Heroku buildpacks

A newly created Heroku application does not know anything about the language and frameworks used by the app. [Buildpacks][buildpacks] are used for this configuration, and have been provided by the community.

Add the Elixir buildpack first, followed by the Phoenix Static buildpack.

<pre>
$ heroku buildpacks:add https://github.com/HashNuke/heroku-buildpack-elixir
$ heroku buildpacks:add https://github.com/gjaldon/phoenix-static-buildpack
</pre>

Note: If heroku complains that `buildpacks` is not a recognized command, and you _happen_ to be a Ruby developer who uses `rbenv`, then see if [this](http://wiki.wsmoak.net/cgi-bin/wiki.pl?HerokuRbenv) helps.


### Step 8: Add PostgreSQL to the Heroku app

Now add the PostgreSQL database to the Heroku application:

<pre>
$ heroku addons:create heroku-postgresql
</pre>

This will make the database available, but it will be empty.  We'll create the database tables and columns shortly.

### Step 9: Set environment variables

Set the SECRET_KEY_BASE environment variable, which is used for cookie-based [session][sessions] storage.

<pre>
$ heroku config:set SECRET_KEY_BASE=[copied from config/prod.secret.exs]
</pre>

### Step 10: Push changes to Heroku

At this point we need to push our changes to Heroku so that it will get the environment set up and build the app.

<pre>
$ git push heroku master
</pre>

### Step 11: Create and migrate the database

Now that Elixir is installed, you have access to the `mix` command which is needed to run the following commands to create and migrate the database.

<pre>
$ heroku run mix ecto.create # ignore error, see below
$ heroku run mix ecto.migrate
</pre>

When running `heroku run mix ecto.create` I received this error:
<pre>
Running `mix ecto.create` attached to terminal... up, run.4650
** (Mix) The database for MyApp.Repo couldn't be created,
reason given: Error: You must install at least one postgresql-client-[version] package.
</pre>

According to <http://stackoverflow.com/questions/17300341/migrate-not-working-on-heroku> and in my experience, this can safely be ignored.

# Step 12: Success!

And finally:
<pre>
$ heroku open
</pre>

This should open the index page of your app.  Add `/users` to the url and see it work, for example: <https://powerful-depths-1590.herokuapp.com/users> .

![Hello Phoenix with Users on Heroku](/images/2015/07/hello-phoenix-users-heroku.png)

### References

* [WIP Heroku deployment guide](https://github.com/phoenixframework/phoenix_guides/pull/314)
* [Ecto Models][ecto-models]
* [Heroku Buildpacks][buildpacks]
* [Elixir Buildpack][elixir-buildpack]
* [Phoenix Static Buildpack][phoenix-static-buildpack]
* [Phoenix Sessions][sessions]

### Troubleshooting

If you see this error after generating the model...
<pre>
Generated phoenix_ecto app
==> my_app
Unchecked dependencies for environment dev:
* postgrex (Hex package)
  the dependency postgrex defined

  > In mix.exs:
    {:postgrex, ">= 0.0.0", [hex: :postgrex]}

  does not match the requirement specified

  > In deps/ecto/mix.exs:
    {:postgrex, "~> 0.8.3", [optional: true, hex: :postgrex]}

  Ensure they match or specify one of the above in your MyApp_323712.Mixfile deps and set `override: true`
** (Mix) Can't continue due to errors on dependencies
</pre>

... it is due to:

3:31 PM [ericmj] there was a bug in hex that has been fixed<br/>
3:32 PM [ericmj] if you update hex it is fine, but if you fetched deps with the broken hex you may have a locked postgrex 0.9.0 which you dont want

The `mix local.hex` command we ran earlier *should* have prevented this, but if not, execute these commands to install the latest one again and [unlock](http://elixir-lang.org/docs/v1.0/mix/Mix.Tasks.Deps.Unlock.html) the postgrex dependency:

<pre>
$ mix local.hex
$ mix deps.unlock
$ mix deps.unlock postgrex
$ mix deps.get
</pre>

[Go back to Step 3](#step-3-add-a-users-model)


[ecto-models]: http://www.phoenixframework.org/docs/ecto-models
[sessions]: http://www.phoenixframework.org/docs/sessions
[buildpacks]: https://devcenter.heroku.com/articles/buildpacks
[phoenix-static-buildpack]: https://github.com/gjaldon/heroku-buildpack-phoenix-static
[elixir-buildpack]: https://github.com/HashNuke/heroku-buildpack-elixir
